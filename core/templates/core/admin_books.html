{% extends 'core/base.html' %}

{% block title %}Manage Books - Admin Panel{% endblock %}

{% block content %}
{% csrf_token %}
<div class="title">
    <h1>Manage Books</h1>
    <h5>View and manage book inventory</h5>
</div>

<div style="width: 90%; margin: 0 auto; padding: 2rem 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h3>All Books</h3>
        <a href="{% url 'admin_add_book' %}" style="background-color: cadetblue; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none;">Add New Book</a>
    </div>
    
    <div style="margin-bottom: 2rem;">
        <form method="get" style="display: flex; gap: 1rem; align-items: center;">
            <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search books by title, author, or ISBN..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.5rem;">
            <button type="submit" style="background-color: cadetblue; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Search</button>
            {% if request.GET.search %}
            <a href="{% url 'admin_books' %}" style="color: cadetblue; text-decoration: none;">Clear</a>
            {% endif %}
        </form>
    </div>
    
    <div style="overflow-x: auto; box-shadow: 0px 2px 10px 2px rgba(0, 0, 0, 0.274); border-radius: 0.5rem;">
        <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead style="background-color: cadetblue; color: white;">
                <tr>
                    <th style="padding: 1rem; text-align: left;">ID</th>
                    <th style="padding: 1rem; text-align: left;">Title</th>
                    <th style="padding: 1rem; text-align: left;">Author</th>
                    <th style="padding: 1rem; text-align: left;">Category</th>
                    <th style="padding: 1rem; text-align: left;">Price</th>
                    <th style="padding: 1rem; text-align: left;">Stock</th>
                    <th style="padding: 1rem; text-align: left;">Created</th>
                    <th style="padding: 1rem; text-align: left;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 1rem;">{{ book.id }}</td>
                    <td style="padding: 1rem;">{{ book.title }}</td>
                    <td style="padding: 1rem;">{{ book.author.name }}</td>
                    <td style="padding: 1rem;">{{ book.category.name }}</td>
                    <td style="padding: 1rem;">KES{{ book.price }}</td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.2rem 0.5rem; border-radius: 0.3rem; {% if book.stock_quantity > 10 %}background-color: #28a745; color: white;{% elif book.stock_quantity > 0 %}background-color: #ffc107; color: black;{% else %}background-color: #dc3545; color: white;{% endif %}">
                            {{ book.stock_quantity }}
                        </span>
                    </td>
                    <td style="padding: 1rem;">{{ book.created_at|date:"M d, Y" }}</td>
                    <td style="padding: 1rem;">
                        <button onclick="editPrice({{ book.id }}, {{ book.price }})" style="background-color: #007bff; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 0.3rem; cursor: pointer; font-size: 0.8rem;">Edit Price</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="padding: 2rem; text-align: center;">No books found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 2rem;">
        <a href="{% url 'admin_panel' %}" style="border: solid 1px cadetblue; color: cadetblue; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none;">Back to Admin Panel</a>
    </div>
</div>

<!-- Price Edit Modal -->
<div id="priceModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 300px; text-align: center;">
        <h3>Edit Book Price</h3>
        <input type="number" id="newPriceInput" step="0.01" min="0" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
        <div style="margin-top: 20px;">
            <button onclick="confirmPriceUpdate()" style="background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Update</button>
            <button onclick="closeModal()" style="background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div id="messageModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 300px; text-align: center;">
        <h3 id="messageTitle">Message</h3>
        <p id="messageText"></p>
        <button onclick="closeMessageModal()" style="background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">OK</button>
    </div>
</div>

<script>
let currentBookId = null;
let searchTimeout;
const searchInput = document.getElementById('live-search');
const booksTableBody = document.getElementById('books-tbody');

searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    clearTimeout(searchTimeout);
    
    searchTimeout = setTimeout(() => {
        fetch(`/admin-search-books/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => displayBooks(data.books))
            .catch(error => console.error('Error:', error));
    }, 300);
});

function displayBooks(books) {
    if (books.length === 0) {
        booksTableBody.innerHTML = '<tr><td colspan="8" style="padding: 2rem; text-align: center;">No books found.</td></tr>';
        return;
    }
    
    let html = '';
    books.forEach(book => {
        let stockColor = '#dc3545';
        let stockTextColor = 'white';
        if (book.stock_quantity > 10) {
            stockColor = '#28a745';
            stockTextColor = 'white';
        } else if (book.stock_quantity > 0) {
            stockColor = '#ffc107';
            stockTextColor = 'black';
        }
        
        html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 1rem;">${book.id}</td>
                <td style="padding: 1rem;">${book.title}</td>
                <td style="padding: 1rem;">${book.author}</td>
                <td style="padding: 1rem;">${book.category}</td>
                <td style="padding: 1rem;">KES${book.price}</td>
                <td style="padding: 1rem;">
                    <span style="padding: 0.2rem 0.5rem; border-radius: 0.3rem; background-color: ${stockColor}; color: ${stockTextColor};">
                        ${book.stock_quantity}
                    </span>
                </td>
                <td style="padding: 1rem;">${book.created_at}</td>
                <td style="padding: 1rem;">
                    <button onclick="editPrice(${book.id}, ${book.price})" style="background-color: #007bff; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 0.3rem; cursor: pointer; font-size: 0.8rem;">Edit Price</button>
                </td>
            </tr>
        `;
    });
    
    booksTableBody.innerHTML = html;
}

function editPrice(bookId, currentPrice) {
    currentBookId = bookId;
    document.getElementById('newPriceInput').value = currentPrice;
    document.getElementById('priceModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('priceModal').style.display = 'none';
    currentBookId = null;
}

function confirmPriceUpdate() {
    const newPrice = document.getElementById('newPriceInput').value;
    if (newPrice && !isNaN(newPrice) && parseFloat(newPrice) > 0) {
        fetch(`/admin-update-book-price/${currentBookId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({price: parseFloat(newPrice)})
        })
        .then(response => response.json())
        .then(data => {
            closeModal();
            if (data.success) {
                location.reload();
            } else {
                showMessage('Error', 'Error updating price: ' + data.message);
            }
        })
        .catch(error => {
            closeModal();
            console.error('Error:', error);
            showMessage('Error', 'Error updating price');
        });
    }
}

function showMessage(title, message) {
    document.getElementById('messageTitle').textContent = title;
    document.getElementById('messageText').textContent = message;
    document.getElementById('messageModal').style.display = 'block';
}

function closeMessageModal() {
    document.getElementById('messageModal').style.display = 'none';
}
</script>
{% endblock %}